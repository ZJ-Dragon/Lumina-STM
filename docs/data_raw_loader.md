# Luminaâ€‘STM

**Luminaâ€‘STM** (Styleâ€‘Transform Module) is an endâ€‘toâ€‘end pipeline that learns to turn **Sony / Nikon RAW photos** into highâ€‘quality, stylised colour renditionsâ€”locally with a lightweight Transformer and in the cloud with a diffusion refiner.

---

## âœ¨ Whatâ€™s inside â€” branch `feature/dataâ€‘rawâ€‘loader`

| Module | Purpose |
|--------|---------|
| `src/data/raw_loader.py` | Decode `.ARW` / `.NEF` â†’ subtract blackâ€‘level â†’ whiteâ€‘level normalise â†’ optional WB â†’ **4â€‘ch RGGB tensor** |
| `src/data/datasets.py` | `RawTensorDataset` with Bayerâ€‘aligned random crop & whiteâ€‘balance jitter |
| `scripts/raw_preprocess.py` | CLI to batch convert **`filters/*/raw/`** into `pipeline/raw_master/` + `pipeline/space2depth/` |
| `tests/unit/test_raw_loader.py` | Unit tests: shape / range / blackâ€‘level correctness |
| `configs/dataloader_raw.yaml` | Dataset root, crop size, WB jitter, DataLoader workers |
| `src/data/augmentations.py` | Compose exposure/WB/noise transforms (shared YAML) |
| `scripts/gen_aug_train.py` | Multiprocess offline augmentation into `pipeline/aug_train/` |
| `configs/augmentations.yaml` | Global switchboard for both offline & online aug |
| `dvc.yaml` (stage augment_train) | Reproducible offline augmentation via DVC |

---

## ğŸ›  Quickâ€‘start

```bash
git clone https://github.com/yourâ€‘org/Luminaâ€‘STM.git
cd Luminaâ€‘STM
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 1. copy & edit environment file
cp .env.example .env           # edit paths / keys
source .env                    # or use pythonâ€‘dotenv

# 2. generate tensors from RAW + (optionally) offline augmentation
dvc repro preprocess_raw                    # base tensors
dvc repro augment_train                     # extra augmented tensors
# or in one go:
python scripts/raw_preprocess.py --cfg configs/dataloader_raw.yaml --augment offline -j 8

# 3. smokeâ€‘test dataloader
pytest tests/unit/test_raw_loader.py -q
```

---

## ğŸ—‚ Directory layout (simplified)

```
Luminaâ€‘STM/
 â”œâ”€ filters/               # raw photos organised by filter name
 â”‚   â””â”€ <filter>/raw/*.ARW
 â”œâ”€ pipeline/              # autogenerated by raw_preprocess.py
 â”‚   â”œâ”€ raw_master/        # linear Bayer (H,W,1)
 â”‚   â”œâ”€ space2depth/       # packed 4â€‘ch tensors (H/2,W/2,4)
 â”‚   â””â”€ aug_train/         # offlineâ€‘augmented 4â€‘ch tensors
 â”œâ”€ src/
 â”‚   â””â”€ data/              # RawLoader & Dataset
 â””â”€ configs/               # YAML configs
```

---

## âš™ï¸ Environment variables

All runtime configuration lives in a `.env` file (ignored by Git).  
` .env.example ` documents every keyâ€”copy & customise.

| Key | Example | Notes |
|-----|---------|-------|
| **DATASETS_ROOT** | `/mnt/raw_pool/Luminaâ€‘STM` | **Must point to the folder that contains `filters/` & `pipeline/`** |
| OUTPUT_ROOT | `./pipeline` | Where checkpoints / logs are stored |
| CUDA_VISIBLE_DEVICES | `0,1` | GPU selection (empty = CPU) |
| NUM_WORKERS | `8` | Default DataLoader worker count |
| AWS_* | *optional* | Needed only if you push data / ckpt to S3 |
| WANDB_* | *optional* | Set if you use Weightsâ€‘andâ€‘Biases tracking |

> **Tip:** edit `.env.example`, commit it; keep your real `.env` local & private.

---

## ğŸ§ª Testing & CI

```bash
pytest -q                      # unit tests
dvc repro preprocess_raw       # data pipeline reproducibility
```

Add a GitHub Action (see `.github/workflows/ci.yml`) to run both commands on every PR.

---

## ğŸ– Data augmentation hook

*Offline* and *online* augmentation now share a single YAML (`configs/augmentations.yaml`).  
*Offline* tensors live in **`pipeline/aug_train/`** and are created by:

```bash
python scripts/gen_aug_train.py pipeline/raw_master pipeline/aug_train -j 8
```

For the theory and tuning tips, see **`docs/data_augmentation.md`** (EN) or **`docs/data_augmentation.zhâ€‘CN.md`** (CN).

---

## ğŸ“œ License

This repository is released under the **ApacheÂ 2.0** licence (see `LICENSE`).