# Luminaâ€‘STM

**Luminaâ€‘STM** (Styleâ€‘Transform Module) is an endâ€‘toâ€‘end pipeline that learns to turn **Sony / Nikon RAW photos** into highâ€‘quality, stylised colour renditionsâ€”locally with a lightweight Transformer and in the cloud with a diffusion refiner.

---

## âœ¨ Whatâ€™s insideâ€¯â€”â€¯branchÂ `feature/dataâ€‘rawâ€‘loader`

| Module | Purpose |
|--------|---------|
| `src/data/raw_loader.py` | Decode `.ARW` / `.NEF` â†’ subtract blackâ€‘level â†’ whiteâ€‘level normalise â†’ optional WB â†’ **4â€‘ch RGGB tensor** |
| `src/data/datasets.py` | `RawTensorDataset` with Bayerâ€‘aligned random crop & whiteâ€‘balance jitter |
| `scripts/raw_preprocess.py` | CLI to batch convert **`filters/*/raw/`** into `pipeline/raw_master/` + `pipeline/space2depth/` |
| `tests/unit/test_raw_loader.py` | Unit tests: shape / range / blackâ€‘level correctness |
| `configs/dataloader_raw.yaml` | Dataset root, crop size, WB jitter, DataLoader workers |
| `.env.example` | Template for all runtime environment variables |
| `dvc.yaml` (stage `preprocess_raw`) | Oneâ€‘command reproducible preprocessing via **DVC** |

---

## ðŸ› Â Quickâ€‘start

```bash
git clone https://github.com/yourâ€‘org/Luminaâ€‘STM.git
cd Luminaâ€‘STM
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# 1. copy & edit environment file
cp .env.example .env           # edit paths / keys
source .env                    # or use pythonâ€‘dotenv

# 2. generate tensors from RAW
dvc repro preprocess_raw       # or: python scripts/raw_preprocess.py --cfg configs/dataloader_raw.yaml

# 3. smokeâ€‘test dataloader
pytest tests/unit/test_raw_loader.py -q
```

---

## ðŸ—‚Â Directory layout (simplified)

```
Luminaâ€‘STM/
 â”œâ”€ filters/               # raw photos organised by filter name
 â”‚   â””â”€ <filter>/raw/*.ARW
 â”œâ”€ pipeline/              # autogenerated by raw_preprocess.py
 â”‚   â”œâ”€ raw_master/        # linear Bayer (H,W,1)
 â”‚   â””â”€ space2depth/       # packed 4â€‘ch tensors (H/2,W/2,4)
 â”œâ”€ src/
 â”‚   â””â”€ data/              # RawLoader & Dataset
 â””â”€ configs/               # YAML configs
```

---

## âš™ï¸Â Environment variables

All runtime configuration lives in a `.env` file (ignored by Git).  
` .env.example ` documents every keyâ€”copy & customise.

| Key | Example | Notes |
|-----|---------|-------|
| **DATASETS_ROOT** | `/mnt/raw_pool/Luminaâ€‘STM` | **Must point to the folder that contains `filters/` & `pipeline/`** |
| OUTPUT_ROOT | `./pipeline` | Where checkpoints / logs are stored |
| CUDA_VISIBLE_DEVICES | `0,1` | GPU selection (empty = CPU) |
| NUM_WORKERS | `8` | Default DataLoader worker count |
| AWS_* | *optional* | Needed only if you push data / ckpt to S3 |
| WANDB_* | *optional* | Set if you use Weightsâ€‘andâ€‘Biases tracking |

> **Tip:** edit `.env.example`, commit it; keep your real `.env` local & private.

---

## ðŸ§ªÂ Testing & CI

```bash
pytest -q                      # unit tests
dvc repro preprocess_raw       # data pipeline reproducibility
```

Add a GitHub Action (see `.github/workflows/ci.yml`) to run both commands on every PR.

---

## ðŸ“œÂ License

This repository is released under the **ApacheÂ 2.0** licence (see `LICENSE`).